{% extends 'travel/home.html' %} {% load static %} 
{% block title %}TravelWise - Create Plan{% endblock %} 

{% load crispy_forms_tags %}{% block create_plan %}
  <div class="container d-flex flex-column flex-grow-1">
    <div id="chat-messages" class="flex-grow-1 d-flex flex-column">
        <div class="assistant">Hello, I am your travel planning assistant. Where would you like to travel?</div>
        
        {% for message in messages %}
            <div class="{{message.role}}">{{message.content}}</div>
        {% endfor %}
    </div>
    <div class="m-4">
        <input type="text" class="form-control" id="chat-input" placeholder="Enter chat message">
    </div>
  </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    
    let chatInput = document.getElementById('chat-input');
    let chatMessages = document.getElementById('chat-messages');
    
    chatInput.addEventListener('keydown', function(event) {
        if(event.keyCode !== 13) {
            return;
        }
        
        api
            .chat(id, chatInput.value)
            .then(function(response) {
                let userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('user');
                userMessageDiv.innerText = chatInput.value;
                chatMessages.appendChild(userMessageDiv);
                
                let message = response['message'];
                
                let messageDiv = document.createElement('div');
                messageDiv.classList.add('assistant');
                messageDiv.innerText = message;
                
                chatMessages.appendChild(messageDiv);
                
                // TODO: Is there an event I can use for this? 
                // Is this correct?
                requestAnimationFrame(() => chatMessages.scrollTo(0, chatMessages.scrollHeight));
            })
            .catch(function(error) {
                alert(error);
            });
    });
    
    window.addEventListener('load', () => {
        chatMessages.scrollTo(0, chatMessages.scrollHeight);
    });
</script>
<style>    
    /* TODO: Consider making the following global */
    html {
        height: 100%;
    }
    
    /* TODO: Consider making the following global */
    body {
        height: 100%;
        display: flex;
        justify-content: center;
        flex-direction: column;
    }
    
    body > section {
        flex-grow: 1;
        display: flex;
        overflow-y: auto;
    }
    
    body > header {
        display: flex;
    }
    
    .user,
    .assistant {
        display: inline;
        margin: 1em;
        padding: 1em;
        color: white;
        border-radius: 1em;
        max-width: 75%;
        white-space: pre-line;
    }
    
    .assistant {
        background-color: #c13022;
    }
    
    .user {
        background-color: #22b3c1;
        margin-left: 25%;
    }
    
    #chat-messages {
        overflow: auto;
    }
</style>
{% endblock %}

